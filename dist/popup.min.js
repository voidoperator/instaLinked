document.addEventListener("DOMContentLoaded",checkIfVariablesAreLoaded),document.getElementById("add-variable").addEventListener("click",addVariable),document.getElementById("preview-message").addEventListener("click",togglePreview),document.getElementById("copy-preview").addEventListener("click",(async()=>{await copyPreviewMessage()})),document.getElementById("copy-template").addEventListener("click",(async()=>{await copyTemplateMessage()})),document.getElementById("auto-send-message").addEventListener("click",(()=>{const e=generateMessage();chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{action:"autoSendMessage",finalTemplateMessage:e});const n=e=>{"autoSendResult"===e.action&&(e.success&&window.close(),chrome.runtime.onMessage.removeListener(n))};chrome.runtime.onMessage.addListener(n)}))}));const reloadButtons=["reload-variables","reset-variables"];function establishConnection(e){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const n=chrome.tabs.connect(t[0].id,{name:"popup"});n.onDisconnect.addListener((function(){chrome.runtime.lastError&&setTimeout((function(){establishConnection(e)}),500)})),e&&e(n)}))}function checkIfVariablesAreLoaded(){const e=document.querySelector("#variables-container"),t=document.querySelector("#reload-wrapper");e.hasChildNodes()?t.classList.add("hidden"):t.classList.remove("hidden")}function displayVariables(e){const t=document.getElementById("variables-container");t.innerHTML="";const n=["FullName","FirstName","LastName","CompanyName","PositionName"];for(const a in e){const o=document.createElement("div");o.classList.add("var-wrapper");const c=document.createElement("input");c.type="checkbox",c.checked=!0;const s=document.createElement("label");s.textContent=a+":";const i=document.createElement("button");i.textContent="Copy",i.title="Copy variable string",i.classList.add("copy-var"),i.addEventListener("click",(function(){copyToClipboard(`{${s.innerText.replace(":","")}}`),i.textContent="Copied!"}));const r=document.createElement("input");r.type="text",r.value=e[a];const l=document.createElement("button");l.textContent="Copy",l.title="Copy variable value",l.classList.add("copy-input"),l.addEventListener("click",(function(){copyToClipboard(r.value),l.textContent="Copied!"}));const d=document.createElement("div");d.classList.add("variableContainer"),d.append(i,c,s);const m=document.createElement("div");if(m.classList.add("userInputContainer"),m.append(r,l),o.append(d,m),t.appendChild(o),!n.includes(a)){const e=document.createElement("button");e.classList.add("remove-var-button"),e.textContent=" — ",e.addEventListener("click",(function(){chrome.storage.sync.get("customVariables",(function(e){const t=e.customVariables;delete t[a],chrome.storage.sync.set({customVariables:t},(function(){console.log("Variable removed.")}))})),o.remove()})),m.appendChild(e)}t.appendChild(o)}checkIfVariablesAreLoaded()}async function copyToClipboard(e){try{await navigator.clipboard.writeText(e)}catch(e){console.error("Failed to copy: ",e)}}function addVariable(e){e.preventDefault();const t=document.getElementById("variables-container"),n=document.createElement("div");n.classList.add("var-wrapper");const a=document.createElement("input");a.type="checkbox",a.checked=!0;const o=document.createElement("button");o.textContent="Copy",o.title="Copy variable string",o.classList.add("copy-var"),o.addEventListener("click",(function(){copyToClipboard(`{${c.value}}`),o.textContent="Copied!"}));const c=document.createElement("input");c.type="text",c.placeholder="Variable Name",n.appendChild(c);const s=document.createElement("input");s.type="text",s.placeholder="Variable Value";const i=document.createElement("button");i.textContent=" — ",i.classList.add("remove-var-button"),i.addEventListener("click",(function(){n.remove()}));const r=document.createElement("div");r.classList.add("variableContainer"),r.append(o,a,c);const l=document.createElement("div");l.classList.add("userInputContainer"),l.append(s,i),n.append(r,l),t.appendChild(n)}function generateMessage(){const e=document.getElementById("variables-container").querySelectorAll("div.var-wrapper"),t=document.getElementById("template-message").value;let n=t||"";const a={FullName:"",FirstName:"",LastName:"",CompanyName:"",PositionName:""},o={};return e.forEach((e=>{let t,c;if(e.querySelector(".variableContainer > input[type='checkbox']").checked){e.querySelector(".variableContainer label")?(t=e.querySelector("label").textContent.replace(":",""),c=e.querySelector(".userInputContainer > input[type='text']").value):(t=e.querySelector("input[placeholder='Variable Name']").value,c=e.querySelector("input[placeholder='Variable Value']").value);const s=new RegExp(`{${t}}`,"g");n=n.replace(s,c),Object.keys(a).includes(t)||(o[t]=c)}})),chrome.storage.sync.set({templateMessage:t,customVariables:o},(function(){console.log("Template message and custom variables saved.")})),n}async function copyPreviewMessage(){const e=document.getElementById("copy-preview"),t=await generateMessage();await copyToClipboard(t).then((()=>{"Copy Preview"===e.textContent.trim()?e.textContent="Preview copied!":e.textContent="Copy Preview"}))}async function copyTemplateMessage(){const e=document.getElementById("template-message"),t=document.getElementById("copy-template");await copyToClipboard(e.value).then((()=>{"Copy Template"===t.textContent.trim()?t.textContent="Template copied!":t.textContent="Copy Template"}))}reloadButtons.map((e=>{document.getElementById(e).addEventListener("click",(()=>{chrome.tabs.query({active:!0,currentWindow:!0},(function(e){const t=chrome.tabs.connect(e[0].id,{name:"popup"});t.postMessage({action:"requestVariables"}),t.onMessage.addListener((e=>{e.success?displayVariables(e.variables):console.error("Failed to fetch variables.")}))})),checkIfVariablesAreLoaded()}))})),establishConnection((function(e){e.postMessage({action:"requestVariables"}),e.onMessage.addListener((function(e){"variablesResponse"===e.action&&chrome.storage.sync.get("customVariables",(function(t){displayVariables({...e.variables,...t.customVariables})}))}))}));let previewVisible=!1;async function togglePreview(){const e=document.getElementById("preview-box"),t=document.getElementById("preview-message");if(e)if(previewVisible)e.classList.add("hidden"),t.textContent="Preview Message",previewVisible=!1;else{e.querySelector("p").innerText=await generateMessage(),e.classList.remove("hidden"),t.textContent="Hide Preview",previewVisible=!0}else{const e=document.getElementById("root"),n=document.createElement("div");n.id="preview-box";const a=document.createElement("p");a.innerText=await generateMessage(),n.appendChild(a),e.appendChild(n),t.textContent="Hide Preview",previewVisible=!0}}chrome.storage.sync.get("templateMessage",(function(e){e.templateMessage&&(document.getElementById("template-message").value=e.templateMessage)}));